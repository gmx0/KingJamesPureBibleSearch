<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>King James Pure Bible Search WebChannel Server</title>
		<link rel="stylesheet" type="text/css" href="jquery/jquery-ui/1.11.4/themes/start/jquery-ui.min.css" />
		<script type="text/javascript" src="jquery/jquery-1.11.3.min.js"></script>
		<script type="text/javascript" src="jquery/jquery-ui/1.11.4/jquery-ui.min.js"></script>
		<script type="text/javascript" src="jquery/jquery-ui/jquery-ui-autocomplete-scroll/0.1.7/jquery.ui.autocomplete.scroll.min.js"></script>
		<link rel="stylesheet" type="text/css" href="jquery/jquery-ui/fancytree/dist/skin-themeroller/ui.fancytree.min.css" />
		<script type="text/javascript" src="jquery/jquery-ui/fancytree/dist/jquery.fancytree-all.min.js"></script>
		<script type="text/javascript" src="jquery/jquery-ui/jquery-loading-overlay/dist/loading-overlay.min.js"></script>
		<script type="text/javascript" src="//videos.dewtronics.com/jwplayer.js"></script>
		<script>jwplayer.key="SjyxnLsm2h+k3+MmIHXmKCwAy/FbnmxJ5e0j9Q==";</script>

		<script type="text/javascript" src="./qwebchannel.js"></script>
		<script type="text/javascript">
			var nSearchPhraseCount = 0;
			var nSearchPhraseNextID = 0;
//			var ndxBrowserCurrent;				// Current Scripture Browser Index
			var nBrowserChapterCurrent = 0;		// Current Scripture Browser Chapter (1 through n, 0 = not init)
			var bkChpStruct;					// Book/Chapter layout for navigation
			var bDoingLocateUpdate = false;		// Set to true when the drop lists are being updated to avoid circular calls
			var ndxPassageReference = 0;		// TPhraseTag relIndex for Passage Reference entered in locateDialog
			var ndxPassageReferenceCount = 0;	// TPhraseTag nCount for Passage Reference entered in locateDialog
			var strBibleUUID = "";				// Selected Bible UUID
			var bSearchInProgress = false;		// Flag to avoid re-entry into setSearchPhrases()
			var bAreConnected = false;			// True when we are connected to the server (and properly initialized)
			var strLastBibleAudioName = "";		// Last Bible Audio Name selected (used to reselect on chapter change)

			//BEGIN SETUP
			function output(message)
			{
				var output = document.getElementById("output");
				output.innerHTML = output.innerHTML + message + "\n";
			}
			$.fn.isOnScreen = function(){
				var viewport = {};
				viewport.top = $(window).scrollTop();
				viewport.bottom = viewport.top + $(window).height();
				var bounds = {};
				bounds.top = this.offset().top;
				bounds.bottom = bounds.top + this.outerHeight();
				return ((bounds.top <= viewport.bottom) && (bounds.bottom >= viewport.top));
			};
			function hideKeyboard() {
				if (!isTouchDevice()) return;
				//this set timeout needed for case when hideKeyborad
				//is called inside of 'onfocus' event handler
				setTimeout(function() {
					//creating temp field
					var field = document.createElement('input');
					field.setAttribute('type', 'text');
					//hiding temp field from peoples eyes
					//-webkit-user-modify is nessesary for Android 4.x
					field.setAttribute('style', 'position:absolute; top: 0px; opacity: 0; -webkit-user-modify: read-write-plaintext-only; left:0px;');
					document.body.appendChild(field);

					//adding onfocus event handler for out temp field
					field.onfocus = function(){
						//this timeout of 200ms is nessasary for Android 2.3.x
						setTimeout(function() {
							field.setAttribute('style', 'display:none;');
							setTimeout(function() {
								document.body.removeChild(field);
								document.body.focus();
							}, 14);
						}, 200);
					};

					//focusing it
					field.focus();
				}, 100);
			}
			function isTouchDevice() {
				return !!('ontouchstart' in window);
			}
			function waitCursor(bAreBusy) {
				if (bAreBusy) {
					if (bAreConnected) {
						$("#loading-target").loadingOverlay();
						document.getElementById("loading-background").style.display = 'block';
						$("body").css("cursor", "progress");
					}
				} else {
					$("#loading-target").loadingOverlay("remove");
					document.getElementById("loading-background").style.display = 'none';
					$("body").css("cursor", "default");
				}
			}
			function makeRelIndex(book, chapter, verse, word)
			{
				return ((book & 0xFF) << 24) |
						((chapter & 0xFF) << 16) |
						((verse & 0xFF) << 8) |
						(word & 0xFF);
			}
			function relIndexBook(ndxRel)
			{
				return ((ndxRel >> 24) & 0xFF);
			}
			function relIndexChapter(ndxRel)
			{
				return ((ndxRel >> 16) & 0xFF);
			}
			function relIndexVerse(ndxRel)
			{
				return ((ndxRel >> 8) & 0xFF);
			}
			function relIndexWord(ndxRel)
			{
				return (ndxRel & 0xFF);
			}
			function scrollTabTop()
			{
				$("html, #tabs").animate({
					scrollTop: 0
				}, 200);
			}
			function doGetCaretPosition(oField) {
				var iCaretPos = 0;

				// IE Support
				if (document.selection) {
					// Set focus on the element
					oField.focus();

					// To get cursor position, get empty selection range
					var oSel = document.selection.createRange();

					// Move selection start to 0 position
					oSel.moveStart('character', -oField.value.length);

					// The caret position is selection length
					iCaretPos = oSel.text.length;
				}
				// Firefox support
				else if (oField.selectionStart || oField.selectionStart == '0') {
					iCaretPos = ((oField.selectionDirection=='backward') ? oField.selectionStart : oField.selectionEnd);
				}
				// Else fallback to field length
				else {
					iCaretPos = oField.value.length;
				}

				return (iCaretPos);
			}
			function scrollToAnchor(anAnchor)
			{
				var element_to_scroll_to = document.getElementById(anAnchor);
				if (element_to_scroll_to)
					element_to_scroll_to.scrollIntoView();
			}
			function closeAllAutoCompleters()
			{
				$(".searchPhraseText").each(function(i, obj) {
					$("#"+this.id).autocomplete("close");
				});
			}
			function enableAllAutoCompleters()
			{
				$(".searchPhraseText").each(function(i, obj) {
					$("#"+this.id).autocomplete("enable");
				});
			}
			function disableAllAutoCompleters()
			{
				$(".searchPhraseText").each(function(i, obj) {
					$("#"+this.id).autocomplete("disable");
				});
			}
			function getSearchWithin()
			{
				var tree = $("#searchWithinTree").fancytree("getTree");
				var root = tree.getFirstChild();

				if (root && (root.isSelected())) {
					return ("");			// Empty string means entire Bible (shortcut)
				} else {
					// Get a list of all selected nodes in searchWithin tree, and convert to a key array:
					var selKeys = $.map(tree.getSelectedNodes(), function(node) {
						if (node.key.indexOf("_") === -1) return node.key;
					});
					if (selKeys.length > 0) {
						return (selKeys.join(","));
					} else {
						return ("-");		// Special mode for "nothing selected"
					}
				}
			}
			function establishConnection(bReconnection) {
				if (bAreConnected) return;

				var baseUrl;
				var basePort;
				if ((/[?&]webChannelBaseUrl=([A-Za-z0-9\-:/\.]+)/.exec(location.search))) {
					baseUrl = (/[?&]webChannelBaseUrl=([A-Za-z0-9\-:/\.]+)/.exec(location.search)[1]);
				} else {
					if ((/[?&]webChannelPort=([0-9]+)/.exec(location.search))) {
						basePort = (/[?&]webChannelPort=([0-9]+)/.exec(location.search)[1]);
					} else {
						basePort = "9340";
					}
					if (location.protocol !== "https:") {
						baseUrl = "ws://" + location.host + ":" + basePort;
					} else {
						baseUrl = "wss://" + location.host + "/ws/";
					}
				}
				output("Connecting to WebSocket server at " + baseUrl + ".");
				var socket = new WebSocket(baseUrl);

				socket.onclose = function()
				{
					bAreConnected = false;
					document.getElementById("status").style.display = 'block';
					document.getElementById("mainbody").style.display = 'none';
					$( "#detailsDialog" ).dialog("close");
					$( "#locateDialog" ).dialog("close");
					output("WebChannel Connection Closed");
					alert("WebChannel Connection Closed");
					$( "#reconnectButton" ).button( "option", "disabled", false );
				};
				socket.onerror = function(error)
				{
					bAreConnected = false;
					$( "#reconnectButton" ).button( "option", "disabled", false );
					document.getElementById("status").style.display = 'block';
					document.getElementById("mainbody").style.display = 'none';
					output("WebChannel Error: " + error);
//					alert("WebChannel Error: " + error);
				};
				socket.onopen = function()
				{
					bAreConnected = true;
					document.getElementById("status").style.display = 'none';
					document.getElementById("mainbody").style.display = 'block';
					$( "#reconnectButton" ).button( "option", "disabled", true );
					output("WebSocket connected, setting up QWebChannel.");
					new QWebChannel(socket, function(channel) {
						// make our kjpbs object accessible globally
						window.kjpbs = channel.objects.kjpbs;

						kjpbs.bibleList.connect(function(strJsonBibleList) {
							setBibleList($.parseJSON(strJsonBibleList));
						});

						kjpbs.bibleSelected.connect(function(bSuccess, strUUID, strJsonBkChpStruct) {
							waitCursor(false);
							if (!bSuccess) {
								output("Bible failed to load");
								alert("Specified Bible is Not Currently Available on the Server!");
							} else {
								output("Bible Successfully Selected");
								bkChpStruct = $.parseJSON(strJsonBkChpStruct);
								setLocateDialogStatic();
								strBibleUUID = strUUID;
								$("#selectBibleList").val(strUUID);
								$("#selectBibleList").selectmenu("refresh");
							}
						});

						kjpbs.searchWithinModelChanged.connect(function(strJsonSearchWithinTree, nSearchScopeMode) {
							var tree = $("#searchWithinTree").fancytree("getTree");
							tree.reload($.parseJSON(strJsonSearchWithinTree));
							$('#searchScope').val(nSearchScopeMode);
							$("#searchScope").selectmenu("refresh");
						});

						kjpbs.broadcast.connect(function(strMessage) {
							if (strMessage) {
								alert(strMessage);
							}
						});

						kjpbs.searchResultsChanged.connect(function(strHtmlSearchResults, strHtmlSummary, strlstOccurrences) {
							if (!strBibleUUID || !bSearchInProgress) return;

							$("#searchResults").html(strHtmlSearchResults);
							$("#searchResultsSummary").html(strHtmlSummary);

							var lstOccurrences = strlstOccurrences.split(";");
							var ndxOccurrences = 0;
							$(".searchPhraseText").each(function(i) {
								if ((this.value) &&
									(!document.getElementById($(this).parents(".searchPhrase").attr("id")+"_Disable").checked) &&
									(ndxOccurrences < lstOccurrences.length)) {
									document.getElementById($(this).parents(".searchPhrase").attr("id")+"_Occurrences").innerHTML = lstOccurrences[ndxOccurrences];
									ndxOccurrences = ndxOccurrences + 1;
								}
							});

							$("#tabs").tabs("option", "active", 0);
							$("#tabs").tabs("refresh");
						});

						kjpbs.searchResultsAppend.connect(function(strHtmlSearchResults, bLast) {
							if (!strBibleUUID || !bSearchInProgress) return;
							if (strHtmlSearchResults) {
								$("#searchResults").append(strHtmlSearchResults);
							}

							$("#tabs").tabs("option", "active", 0);
							$("#tabs").tabs("refresh");
//							scrollTabTop();
							// Wait cursor back off
							waitCursor(false);
//							enableAllAutoCompleters();
							closeAllAutoCompleters();
							disableAllAutoCompleters();
							bSearchInProgress = false;
							if (bLast === true) {
								document.getElementById("moreSearchResults").style.display = 'none';
							} else {
								document.getElementById("moreSearchResults").style.display = 'block';
							}
						});

						kjpbs.searchResultsDetails.connect(function(ndxLogical, strDetails) {
							if (ndxLogical) {
								$("#detailsDialog").html(strDetails);
								$("#detailsDialog").dialog("open");
								if (!$("#detailsDialog").dialog("widget").isOnScreen()) {
									$("#detailsDialog").dialog("widget").position({
										my: "center",
										at: "center",
										of: window
									});
								}
							}
						});

						kjpbs.scriptureBrowserRender.connect(function(nChp, ndxRel, strHtmlScripture, strParam) {
// ndxBrowserCurrent is obsolete (doesn't make much sense) if we employ caching:
//							ndxBrowserCurrent = ndxRel;

							addPage(nChp, strHtmlScripture + '<div class="kjpbs_link"><a href="//www.purebiblesearch.com/" target="_blank">Visit PureBibleSearch.com</a></div>');

							var opts = strParam.split(",");
							// Select the text from the navigation if 'highlightAnchor' option and anchor is valid:
							if ($.inArray("highlightAnchor", opts) > -1) {
								highlightAnchor(ndxRel);
							}
							if ($.inArray("noturn", opts) == -1) {
								turnToPage(nChp);

								$("#tabs").tabs("option", "active", 1);
								$("#tabs").tabs("refresh");
								if (($.inArray("highlightAnchor", opts) > -1) ||
									($.inArray("scrollToAnchor", opts) > -1)) {
									scrollToAnchor(ndxRel);
								} else if ($.inArray("scrollTabTop", opts) > -1) {
									scrollTabTop();
								}
							}
							// Wait cursor back off
							waitCursor(false);
						});

						kjpbs.setBibleAudioURLs.connect(function(strURLListJson) {
							setBibleAudioList($.parseJSON(strURLListJson));
						});

						kjpbs.setAutoCorrectText.connect(function(strElementID, strAC) {
							document.getElementById(strElementID+"_AC").innerHTML = "&nbsp;" + strAC;
							$("#"+strElementID+"_Text").autocomplete("enable");
						});

						kjpbs.setAutoCompleter.connect(function(strElementID, strlstCompleter) {
							$("#"+strElementID+"_Text").autocomplete("option", "source", strlstCompleter.split(";"));
						});

						kjpbs.updatePhrase.connect(function(strElementID, strNewPhrase) {
							document.getElementById(strElementID+"_Text").value = strNewPhrase;
							searchPhraseChanged(strElementID);
						});

						kjpbs.resolvedPassageReference.connect(function(ndxRel, nCount) {
							ndxPassageReference = ndxRel;
							ndxPassageReferenceCount = nCount;
							if (ndxRel == 0) {
								document.getElementById("passageReference").style.color = "#FF0000";
								document.getElementById("passageReferenceLabel").style.color = "#FF0000";
							} else {
								document.getElementById("passageReference").style.color = "#000000";
								document.getElementById("passageReferenceLabel").style.color = "#000000";
							}
						});

						window.kjpbs.setUserAgent(navigator.userAgent);

						output("Connected to WebChannel, ready to send/receive searches!");

						waitCursor(true);		// important for slow connections so UI disables and keeps user from getting us out of sync

						if (!bReconnection) {
							if ((/[?&]bible=([A-Za-z0-9\-:/\.]+)/.exec(location.search))) {
								strBibleUUID = (/[?&]bible=([A-Za-z0-9\-:/\.]+)/.exec(location.search)[1]);
							}
						}

						output("Selecting Bible...");
						window.kjpbs.selectBible(strBibleUUID);

						if (!bReconnection) {
							var nOpenChapter;

							if ((/[?&]chapter=([A-Za-z0-9\-:/\.]+)/.exec(location.search))) {
								nOpenChapter = (/[?&]chapter=([A-Za-z0-9\-:/\.]+)/.exec(location.search)[1]);
								window.kjpbs.gotoChapter(nOpenChapter, "scrollTabTop");
							} else {
								window.kjpbs.gotoIndex(0, 1, "scrollTabTop");
							}
							hideKeyboard();
						}
					});

					// Close heading after 5 seconds to get it out of the way on mobile devices:
//					setTimeout(function()
//					{
//						document.getElementById("status").style.display = 'none';
//					}, 5000);
				}
			}
			window.onload = function() {
				establishConnection(false);
			}
			function reconnect() {
				document.getElementById("reconnectButton").blur();	// Workaround jqueryui bug
				$("#reconnectButton").removeClass('ui-state-focus ui-state-hover ui-state-active');
				if (!bAreConnected) {
					// Must reset previous search -- even though we aren't actually changing
					//	Bibles, the server will no longer have the search results when the
					//	socket drops, meaning the search results details, etc, won't display
					//	correctly with the old stale data:
					resetForBibleSelect();
					establishConnection(true);
				}
			}
			//END SETUP

			function addSearchPhrase() {
				document.getElementById("addSearchPhraseButton").blur();	// Workaround jqueryui bug
				$("#addSearchPhraseButton").removeClass('ui-state-focus ui-state-hover ui-state-active');

				nSearchPhraseCount = nSearchPhraseCount + 1;
				nSearchPhraseNextID = nSearchPhraseNextID + 1;
				$("#phrases").append('<div class="searchPhrase" id="searchPhrase_' + nSearchPhraseNextID + '"></div>');
				var newPhrase = $("#searchPhrase_" + nSearchPhraseNextID);
				newPhrase.append('<table class="searchPhraseTable" id="searchPhrase_' + nSearchPhraseNextID + '_Table"></table>');
				var phraseTable = $("#searchPhrase_" + nSearchPhraseNextID + "_Table");
				phraseTable.append('<tr></tr>');
				var trOccurrences = phraseTable.find("tr").first();
				trOccurrences.append('<td colspan="4"></td>');
				var tdOccurrences = trOccurrences.find("td").first();
				if (($(window).width() < 512) || ($(window).height() < 512)) {
					tdOccurrences.append('<label for="searchPhrase_' + nSearchPhraseNextID + '_Occurrences">Occurrences:&nbsp;</label><div class="searchPhraseOccurrences" id="searchPhrase_' + nSearchPhraseNextID + '_Occurrences">N/A</div>');
				} else {
					tdOccurrences.append('<label for="searchPhrase_' + nSearchPhraseNextID + '_Occurrences">Number of Occurrences:&nbsp;</label><div class="searchPhraseOccurrences" id="searchPhrase_' + nSearchPhraseNextID + '_Occurrences">N/A</div>');
				}
				phraseTable.append('<tr></tr>');
				var trAC = phraseTable.find("tr").first().next();
				trAC.append('<td class="expand"></td>');
				trAC.append('<td>&nbsp;</td>');
				trAC.append('<td></td>');
				trAC.append('<td></td>');
				var tdAC = trAC.find("td").first();
				tdAC.append('<p class="searchPhraseAC" id="searchPhrase_' + nSearchPhraseNextID + '_AC">&nbsp;</p>');
				phraseTable.append('<tr></tr>');
				var trInput = phraseTable.find("tr").first().next().next();
				trInput.append('<td class="expand"></td>');
				trInput.append('<td>&nbsp;</td>');
				trInput.append('<td></td>');
				trInput.append('<td></td>');
				var tdInput = trInput.find("td").first();
				tdInput.append('<input class="searchPhraseText" id="searchPhrase_' + nSearchPhraseNextID + '_Text" type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" onchange="javascript:searchPhraseChanged(\'searchPhrase_' + nSearchPhraseNextID + '\');" />')
							.on('change keyup paste input', function() { searchPhraseTextChanged($(this).parents(".searchPhrase").attr("id")); });
				var tdBesome = trInput.find("td").first().next().next();
				tdBesome.append('<button value="Clear" class="searchPhraseBesome" id="searchPhrase_' + nSearchPhraseNextID + '_Besome" onclick="javascript:searchPhraseBesome(\'searchPhrase_' + nSearchPhraseNextID + '\');"><img height="100%" style="border: none; margin: 0; padding: 0;" src="edit_clear.png" /></button>');
				var tdClose = trInput.find("td").first().next().next().next();
				tdClose.append('<button value="Close" class="searchPhraseClose" id="searchPhrase_' + nSearchPhraseNextID + '_Close" onclick="javascript:searchPhraseClose(\'searchPhrase_' + nSearchPhraseNextID + '\');"><img height="100%" style="border: none; margin: 0; padding: 0;" src="Close.png" /></button>');
				phraseTable.append('<tr></tr>');
				var trOpts = phraseTable.find("tr").first().next().next().next();
				trOpts.append('<td colspan="4"><table class="searchPhraseOpts"><tr></tr><tr></tr></table></td>');
				var trCheckboxOpts = trOpts.find("tr").first();
				if (($(window).width() < 512) || ($(window).height() < 512)) {
					trCheckboxOpts.append('<td class="searchPhraseOpts"><input type="checkbox" class="checkboxitem" name="CaseSensitive" id="searchPhrase_' + nSearchPhraseNextID + '_CaseSensitive" onclick="javascript:searchPhraseOptsChanged(\'searchPhrase_' + nSearchPhraseNextID + '\');" /><label for="searchPhrase_' + nSearchPhraseNextID + '_CaseSensitive">Case</label></td>');
					trCheckboxOpts.append('<td class="searchPhraseOpts"><input type="checkbox" class="checkboxitem" name="AccentSensitive" id="searchPhrase_' + nSearchPhraseNextID + '_AccentSensitive" onclick="javascript:searchPhraseOptsChanged(\'searchPhrase_' + nSearchPhraseNextID + '\');" /><label for="searchPhrase_' + nSearchPhraseNextID + '_AccentSensitive">Accent</label></td>');
				} else {
					trCheckboxOpts.append('<td class="searchPhraseOpts"><input type="checkbox" class="checkboxitem" name="CaseSensitive" id="searchPhrase_' + nSearchPhraseNextID + '_CaseSensitive" onclick="javascript:searchPhraseOptsChanged(\'searchPhrase_' + nSearchPhraseNextID + '\');" /><label for="searchPhrase_' + nSearchPhraseNextID + '_CaseSensitive">Case Sensitive</label></td>');
					trCheckboxOpts.append('<td class="searchPhraseOpts"><input type="checkbox" class="checkboxitem" name="AccentSensitive" id="searchPhrase_' + nSearchPhraseNextID + '_AccentSensitive" onclick="javascript:searchPhraseOptsChanged(\'searchPhrase_' + nSearchPhraseNextID + '\');" /><label for="searchPhrase_' + nSearchPhraseNextID + '_AccentSensitive">Accent/Ligature Sensitive</label></td>');
				}
				trCheckboxOpts.append('<td class="searchPhraseOpts"><input type="checkbox" class="checkboxitem" name="Exclude" id="searchPhrase_' + nSearchPhraseNextID + '_Exclude" onclick="javascript:searchPhraseOptsChanged(\'searchPhrase_' + nSearchPhraseNextID + '\');" /><label for="searchPhrase_' + nSearchPhraseNextID + '_Exclude">Exclude</label></td>');
				trCheckboxOpts.append('<td class="searchPhraseOpts"><input type="checkbox" class="checkboxitem" name="Disable" id="searchPhrase_' + nSearchPhraseNextID + '_Disable" onclick="javascript:searchPhraseOptsChanged(\'searchPhrase_' + nSearchPhraseNextID + '\');" /><label for="searchPhrase_' + nSearchPhraseNextID + '_Disable">Disable</label></td>');
				var trConstraint = trOpts.find("tr").first().next();
				trConstraint.append('<td colspan="4"></td>');
				var tdConstrainTo = trConstraint.find("td").first();
				tdConstrainTo.append('<label for="searchPhrase_' + nSearchPhraseNextID + '_ConstrainTo">Constrain To:</label>');
				tdConstrainTo.append('<select class="constrainTo" name="ConstrainTo" id="searchPhrase_' + nSearchPhraseNextID + '_ConstrainTo" onchange="javascript:searchPhraseOptsChanged(\'searchPhrase_' + nSearchPhraseNextID + '\');"><option value="0">Unconstrained</option><option value="3">Book</option><option value="2">Chapter</option><option value="1">Verse</option></select>');
				phraseTable.append('<tr></tr>');
				var trBreak = phraseTable.find("tr").first().next().next().next().next();
				trBreak.append('<td colspan="4"></td>');
				var tdBreak = trBreak.find("td").first();
				tdBreak.append('<hr class="searchPhraseBreak" />');
				$("#searchPhrase_"+nSearchPhraseNextID+"_Text").data("wasSelect", false);
				$("#searchPhrase_"+nSearchPhraseNextID+"_Text").autocomplete({
					delay: 500,
					maxShowItems: 5,
					minLength: 1,
					source: [ "" ],
					open: function(event, ui)
					{
						$("#"+this.id).data("wasSelect", false);
						return true;
					},
					select: function(event, ui)
					{
						$("#"+this.id).data("wasSelect", true);
						window.kjpbs.calcUpdatedPhrase($("#"+this.id).parents(".searchPhrase").attr("id"), this.value, ui.item.value, doGetCaretPosition(this));
						event.preventDefault();
						return false;
					},
					focus: function(event, ui)
					{
						event.preventDefault();
						return false;
					}
				}).keydown(function(e) {
					e = e || window.event;
					if (e.keyCode == 13) {
						e.preventDefault();
					}
				}).keyup(function(e) {
					e = e || window.event;
					if (e.keyCode == 13) {
						if ($("#"+this.id).data("wasSelect") == false) {
							hideKeyboard();
							document.activeElement.blur();
							searchPhraseTextChanged($("#"+this.id).parents(".searchPhrase").attr("id"));
							searchPhraseChanged();
						} else {
							$("#"+this.id).data("wasSelect", false);
						}
					}
				});

				$("#searchPhrase_"+nSearchPhraseNextID+"_Text").data("LastCurPos", -1);
				$("#searchPhrase_"+nSearchPhraseNextID+"_Text").data("LastPhrase", "");
				$(document).ready(function() {
					$("#searchPhrase_"+nSearchPhraseNextID+"_Text").bind("keyup click paste focus blur", function() {
						autoCorrect($("#"+this.id).parents(".searchPhrase").attr("id"));
					});

					$(".searchPhraseText").on("focus", function() {
						if (isTouchDevice()) {
							if (document.activeElement) {
								document.activeElement.scrollIntoView();
							}
						}
					});
					$(".passageReference").on("focus", function() {
						if (isTouchDevice()) {
							if (document.activeElement) {
								document.activeElement.scrollIntoView();
							}
						}
					});

				});
				$("#tabs").tabs("refresh");
				$("#searchPhrase_"+nSearchPhraseNextID+"_Text").focus();
				$("#searchPhrase_"+nSearchPhraseNextID+"_Text")[0].scrollIntoView();
				if (nSearchPhraseCount >= 5) {
					$( "#addSearchPhraseButton" ).button( "option", "disabled", true );
				}
			}
			$.ui.autocomplete.filter = function (array, term) {
				var matcher = new RegExp("^|\|" + $.ui.autocomplete.escapeRegex(term), "i");
				return $.grep(array, function (value) {
					return matcher.test(value.label || value.value || value);
				});
			};
			function autoCorrect(aSearchPhrase) {
				var input = document.getElementById(aSearchPhrase+"_Text");
				var nCurPos = doGetCaretPosition(input);
				if ((nCurPos != $("#"+aSearchPhrase+"_Text").data("LastCurPos")) ||
					(input.value != $("#"+aSearchPhrase+"_Text").data("LastPhrase"))) {
					if (input.value) {
						window.kjpbs.autoCorrect(aSearchPhrase, input.value, nCurPos, $("#"+aSearchPhrase+"_Text").data("LastPhrase"), $("#"+aSearchPhrase+"_Text").data("LastCurPos"));
						$("#"+aSearchPhrase+"_Text").data("LastCurPos", nCurPos);
					}
					$("#"+aSearchPhrase+"_Text").data("LastPhrase", input.value);
					$("#"+aSearchPhrase+"_Text").autocomplete("close");
//					closeAllAutoCompleters();
				}
			}

			function searchPhraseChanged(aSearchPhrase) {
				if (bSearchInProgress) return;
				bSearchInProgress = true;

				var phrases = "";
				$(".searchPhraseText").each(function(i) {
					if (this.value) {
						if (phrases) {
							phrases = phrases + ";"
						}
						// order matters, see CPhraseEntry!
						var nConstrainTo = document.getElementById($(this).parents(".searchPhrase").attr("id")+"_ConstrainTo").value;
						if (nConstrainTo == 1) {
							phrases = phrases + '\u2460';
						} else if (nConstrainTo == 2) {
							phrases = phrases + '\u2461';
						} else if (nConstrainTo == 3) {
							phrases = phrases + '\u2462';
						}
						if (document.getElementById($(this).parents(".searchPhrase").attr("id")+"_Disable").checked) {
							phrases = phrases + '\u00AC';
							document.getElementById($(this).parents(".searchPhrase").attr("id")+"_Occurrences").innerHTML = "N/A";
						}
						if (document.getElementById($(this).parents(".searchPhrase").attr("id")+"_Exclude").checked) {
							phrases = phrases + '\u2209';
						}
						if (document.getElementById($(this).parents(".searchPhrase").attr("id")+"_AccentSensitive").checked) {
							phrases = phrases + '\u00A4';
						}
						if (document.getElementById($(this).parents(".searchPhrase").attr("id")+"_CaseSensitive").checked) {
							phrases = phrases + '\u00A7';
						}
						phrases = phrases + this.value;
					}
				});
				if (aSearchPhrase) {
					var bDisable = document.getElementById(aSearchPhrase + "_Disable").checked;
					document.getElementById(aSearchPhrase + "_Text").disabled = bDisable;
					document.getElementById(aSearchPhrase + "_CaseSensitive").disabled = bDisable;
					document.getElementById(aSearchPhrase + "_AccentSensitive").disabled = bDisable;
					document.getElementById(aSearchPhrase + "_Exclude").disabled = bDisable;
					document.getElementById(aSearchPhrase + "_Besome").disabled = bDisable;
					document.getElementById(aSearchPhrase + "_ConstrainTo").disabled = bDisable;
				}
				if (!phrases) {
					document.getElementById("moreSearchResults").style.display = 'none';
					document.getElementById("searchResults").innerHTML = "";
					document.getElementById("searchResultsSummary").innerHTML = "";
					$("#tabs").tabs("option", "active", 0);
					$("#tabs").tabs("refresh");
//					scrollTabTop();
					closeAllAutoCompleters();
					cleanPages();
					bSearchInProgress = false;
					return;
				}

				waitCursor(true);
				if (aSearchPhrase) {
					$("#"+aSearchPhrase+"_Text").autocomplete("close");
				} else {
					closeAllAutoCompleters();
				}
//				disableAllAutoCompleters();
				cleanPages();
				window.kjpbs.setSearchPhrases(phrases, getSearchWithin(), $('#searchScope').val());
			}

			function getMoreSearchResults() {
				document.getElementById("getMoreSearchResultsButton").blur();	// Workaround jqueryui bug
				$("#getMoreSearchResultsButton").removeClass('ui-state-focus ui-state-hover ui-state-active');

				if (bSearchInProgress) return;
				bSearchInProgress = true;
				waitCursor(true);
				window.kjpbs.getMoreSearchResults();
			}

			function searchPhraseOptsChanged(aSearchPhrase) {
				searchPhraseChanged(aSearchPhrase);
			}

			function searchPhraseTextChanged(aSearchPhrase) {
				var input = document.getElementById(aSearchPhrase+"_Text");
				var theAC = document.getElementById(aSearchPhrase+"_AC");
				var theOccurrences = document.getElementById(aSearchPhrase+"_Occurrences");
				if (!input.value) {
					theAC.innerHTML = "&nbsp;";
					theOccurrences.innerHTML = "N/A";
				} else {
					if (input.value != $("#"+aSearchPhrase+"_Text").data("LastPhrase")) {
						theOccurrences.innerHTML = "???";
					}
					autoCorrect(aSearchPhrase);
				}
			}

			function searchPhraseBesome(aSearchPhrase) {
				var input = document.getElementById(aSearchPhrase+"_Text");
				input.value = "";
				searchPhraseTextChanged(aSearchPhrase);
				searchPhraseChanged(aSearchPhrase);
				input.focus();
			}

			function searchPhraseClose(aSearchPhrase) {
				if (nSearchPhraseCount <= 1) {
					// If there's only 1 search phrase left, treat it as a clear instead,
					//		however, re-enable it if it was disabled and reset other flags
					//		to treat it like a destroy and re-create:
					document.getElementById(aSearchPhrase + "_Disable").checked = false;
					document.getElementById(aSearchPhrase + "_Exclude").checked = false;
					document.getElementById(aSearchPhrase + "_AccentSensitive").checked = false;
					document.getElementById(aSearchPhrase + "_CaseSensitive").checked = false;
					searchPhraseBesome(aSearchPhrase);
				} else {
					var nextPhrase = $("#"+aSearchPhrase).next();
					if (!nextPhrase.length) {
						nextPhrase = $("#"+aSearchPhrase).prev();
					}
					$("#"+aSearchPhrase).remove();
					nSearchPhraseCount = nSearchPhraseCount - 1;
					searchPhraseChanged();
					$("#"+nextPhrase.attr("id")+"_Text").focus();

					if (nSearchPhraseCount < 5) {
						$( "#addSearchPhraseButton" ).button( "option", "disabled", false );
					}
				}
			}

			function resolvePassageReference(strPassageReference)
			{
				window.kjpbs.resolvePassageReference(strPassageReference);
			}

			function gotoIndex(ndx, nMoveMode, strParam)
			{
				waitCursor(true);
				window.kjpbs.gotoIndex(ndx, nMoveMode, strParam);
			}

			function gotoResult(nChp, ndxRel)
			{
				if (havePage(nChp)) {
					turnToPage(nChp);
					highlightAnchor(ndxRel);
				} else {
					gotoIndex(ndxRel, 0, "highlightAnchor");
				}
			}

			function viewDetails(ndxLogical)
			{
				window.kjpbs.getSearchResultDetails(ndxLogical);
			}

			function gotoChapter(nChp, strParam)
			{
				if (window.kjpbs) {
					waitCursor(true);
					window.kjpbs.gotoChapter(nChp, strParam);
				}
			}

			function highlightAnchor(ndxRel)
			{
				var anchorElement = $("#" + ndxRel);
				if (anchorElement) {
					anchorElement.addClass("selected");
					if (anchorElement.next()) {
						anchorElement.next().addClass("selected");
					}
					if (anchorElement.closest(".verse")) {
						anchorElement.closest(".verse").addClass("selected");
					}
				}
			}

			document.onkeydown = function (e) {

				e = e || window.event;

				if (e.altKey) {
					switch (e.keyCode) {
						case 37:		// Left arrow
							closeAllAutoCompleters();
							$("#tabs").tabs("option", "active",
									(($("#tabs").tabs("option", "active") == 0) ?
											$("#tabs").tabs("option", "active", 1) :
											$("#tabs").tabs("option", "active", $("#tabs").tabs("option", "active")-1)));
							break;
						case 39:		// Right arrow
							closeAllAutoCompleters();
							$("#tabs").tabs("option", "active",
									(($("#tabs").tabs("option", "active") == 1) ?
											$("#tabs").tabs("option", "active", 0) :
											$("#tabs").tabs("option", "active", $("#tabs").tabs("option", "active")+1)));
							break;
						// Note: up=38, down=40
						default:
							return;
					}
					e.preventDefault();
				} else {
					switch (e.keyCode) {
						case 13:		// Enter
							closeAllAutoCompleters();
							if (document.activeElement && document.activeElement.id) {
								if ($("#"+document.activeElement.id).hasClass("passageReference")) {
									if (ndxPassageReference != 0) {
										document.getElementById("gotoPassageButton").click();
									}
								}
							}
							return;
					}
				}
			}

			function havePage(page) {
				// TODO : Lookup page in cache
				return false;
			}

			// Adds the pages that the "Scripture Book" will need
			function addPage(page, strText) {
				if (!havePage(page)) {
					// TODO : Add page to cache
					document.getElementById("scriptureText").innerHTML = strText;
				} else {
					document.getElementById("scriptureText").innerHTML = strText;
				}
			}

			// Clear pages removes the "Scripture Book" content for existing
			//		pages so they can be refetched (such as search changed
			//		where the highlighting/markup has changed)
			function cleanPages() {
				// TODO : Clear page cache
			}

			function turnToPage(page) {
				// TODO : Switch to page

				nBrowserChapterCurrent = page;
			}

			function setBibleList(jsonBibleList) {
				var selectBibleList = document.getElementById("selectBibleList");
				var defaultUUID;
				selectBibleList.options.length = 0;
				$.each(jsonBibleList, function(index, itemData) {
					$("<option value='" + itemData.id + "'>" + itemData.name
						+ "</option>").appendTo("#selectBibleList");
					if (itemData.isDefault === true) {
						defaultUUID = itemData.id;
					}
				});
				$("#selectBibleList").selectmenu("refresh");
				if (defaultUUID) {
					$("#selectBibleList").val(defaultUUID);
					$("#selectBibleList").selectmenu("refresh");
				}
			}

			function resetForBibleSelect()
			{
				// Clear out the old search since it's not applicable to new database:
				$(".searchPhraseText").each(function(i) {
					var phraseID = $("#"+this.id).parents(".searchPhrase").attr("id");
					this.value = "";
					searchPhraseTextChanged(phraseID);
					$("#"+this.id).autocomplete("option", "source", [""]);
					$("#"+this.id).autocomplete("disable");
				});
				bSearchInProgress = false;
				searchPhraseChanged();
				$("#tabs").tabs("option", "active", 1);		// Switch back to scripture tab
				$("#tabs").tabs("refresh");
			}

			function selectBible()
			{
				$("#selectBibleList").selectmenu("widget").blur();
				if (strBibleUUID != $("#selectBibleList").val()) {
					strBibleUUID = "";			// Force search results input to halt, just in case
					waitCursor(true);
					resetForBibleSelect();
					window.kjpbs.selectBible($("#selectBibleList").val());
					window.kjpbs.gotoIndex(0, 1, "scrollTabTop");			// Goto start of Bible text since chapter layout may be different or else it will appear like we didn't load it
				}
			}

			function setBibleAudioList(jsonBibleAudioList) {
				if (jsonBibleAudioList && jsonBibleAudioList.length) {
					var defaultAudio = "";
					document.getElementById("bibleAudio").style.display = 'block';
					document.getElementById("bibleAudioControls").style.display = 'block';

					var selectBibleAudio = document.getElementById("selectBibleAudio");
					selectBibleAudio.options.length = 0;
					$("<option value=''>-- None --</option>").appendTo("#selectBibleAudio");
					$.each(jsonBibleAudioList, function(index, itemData) {
						$("<option value='" + itemData.url + "'>" + itemData.name
							+ "</option>").appendTo("#selectBibleAudio");
						if (((strLastBibleAudioName) && (itemData.name == strLastBibleAudioName)) || (jsonBibleAudioList.length == 1)) {
							defaultAudio = itemData.url;
						}
					});
					if (defaultAudio) {
						$("#selectBibleAudio").val(defaultAudio);
					} else {
						$("#selectBibleAudio").val("");
					}
					setBibleAudio();
				} else {
					strLastBibleAudioName = "";
					document.getElementById("bibleAudio").style.display = 'none';
					document.getElementById("bibleAudioControls").style.display = 'none';
					jwplayer("bibleAudio").remove();
				}
			}

			function setBibleAudio() {
				var strURL = $("#selectBibleAudio").val();
				if (strURL) {
					strLastBibleAudioName = $("#selectBibleAudio").find('option:selected').text();
					document.getElementById("bibleAudio").style.display = 'block';
					jwplayer("bibleAudio").setup({
						file: strURL,
						displaytitle: true,
						height: 40,
						width: "100%",
						controls: true,
						mute: false,
						playbackRate: $("#bibleAudioSpeed").val(),
// Note: autostart does NOT work on mobile devices:
//						autostart: document.getElementById("bibleAudioPlayNext").checked,
						repeat: false,
						flashplayer: "//videos.dewtronics.com/jwplayer.flash.swf",
						skin: {
							"name" : "bekle"
						},
						events:{
							onComplete: function() {
								if (document.getElementById("bibleAudioPlayNext").checked) {
									navNextChapter();
								}
							},
							onPlay: function() {
								var bibleAudioV = document.getElementById("bibleAudio").querySelector("video");
								var bibleAudioA = document.getElementById("bibleAudio").querySelector("audio");
								if (bibleAudioV || bibleAudioA) {
									// HTML5 only
									if (bibleAudioV) {
										bibleAudioV.playbackRate = $("#bibleAudioSpeed").val();
									}
									if (bibleAudioA) {
										bibleAudioA.playbackRate = $("#bibleAudioSpeed").val();
									}
									document.getElementById("bibleAudioSpeed").disabled = false;
								} else {
									document.getElementById("bibleAudioSpeed").disabled = true;
								}
							},
							onReady: function() {
								if (document.getElementById("bibleAudioPlayNext").checked) {
									this.play(true);
								}
							}
						},
					});
				} else {
					strLastBibleAudioName = "";
					document.getElementById("bibleAudio").style.display = 'none';
					jwplayer("bibleAudio").remove();
				}
			}

			function changedBibleAudioSpeed() {
				var bibleAudioV = document.getElementById("bibleAudio").querySelector("video");
				var bibleAudioA = document.getElementById("bibleAudio").querySelector("audio");
				if (bibleAudioV || bibleAudioA) {
					// HTML5 only
					if (bibleAudioV) {
						bibleAudioV.playbackRate = $("#bibleAudioSpeed").val();
					}
					if (bibleAudioA) {
						bibleAudioA.playbackRate = $("#bibleAudioSpeed").val();
					}
					document.getElementById("bibleAudioSpeed").disabled = false;
				} else {
					document.getElementById("bibleAudioSpeed").disabled = true;
				}
			}

			function navPrevChapter() {
				if (nBrowserChapterCurrent > 1) {
					gotoChapter(nBrowserChapterCurrent-1, "scrollTabTop");
				}
				document.getElementById("prevChpButton").blur();	// Workaround jqueryui bug
				$("#prevChpButton").removeClass('ui-state-focus ui-state-hover ui-state-active');
			}

			function navNextChapter() {
				if (nBrowserChapterCurrent < bkChpStruct.chapterCount) {
					gotoChapter(nBrowserChapterCurrent+1, "scrollTabTop");
				}
				document.getElementById("nextChpButton").blur();	// Workaround jqueryui bug
				$("#nextChpButton").removeClass('ui-state-focus ui-state-hover ui-state-active');
			}

			function navLocate() {
				document.getElementById("locateButton").blur();	// Workaround jqueryui bug
				$("#locateButton").removeClass('ui-state-focus ui-state-hover ui-state-active');

				$("#passageReference").val("");
				document.getElementById("passageReference").style.color = "#000000";
				document.getElementById("passageReferenceLabel").style.color = "#000000";
				ndxPassageReference = 0;
				ndxPassageReferenceCount = 0;
				setLocateDialogToChapter(nBrowserChapterCurrent);
				$( "#locateDialog" ).dialog( "open" );
			}

			function setLocateDialogStatic()
			{
				var bookSelect = document.getElementById("bookSelect");
				var bblBookSelect = document.getElementById("bblBookSelect");
				var bblChapterSelect = document.getElementById("bblChapterSelect");
				bookSelect.options.length = 0;
				bblBookSelect.options.length = 0;
				bblChapterSelect.options.length = 0;
				var nChapter = 1;
				for (i = 0; i < bkChpStruct.bookCount; i++) {
					bookSelect.options[bookSelect.options.length] = new Option(bkChpStruct.books[i].name, nChapter);
					bblBookSelect.options[bblBookSelect.options.length] = new Option(i+1, nChapter);
					for (j = 0; j < bkChpStruct.books[i].chapterCount; j++) {
						bblChapterSelect.options[bblChapterSelect.options.length] = new Option(nChapter, nChapter);
						nChapter = nChapter + 1;
					}
				}
			}

			function setLocateDialogToChapter(nChapterInBible)
			{
				if (nChapterInBible == 0) {
					return;
				}
				var nBook;
				var nBookStartChapter;
				var nChapterInBook;
				var nTestament;
				var nTestamentStartChapter;
				var nTestamentStartBook;
				var nChapterInTestament;

				nBook = 1;
				nBookStartChapter = 1;
				nChapterInBook = nChapterInBible;
				for (i = 0; i < bkChpStruct.bookCount; i++) {
					if (nChapterInBook <= bkChpStruct.books[i].chapterCount) {
						break;
					}
					nBook = nBook + 1;
					nChapterInBook = nChapterInBook - bkChpStruct.books[i].chapterCount;
					nBookStartChapter = nBookStartChapter + bkChpStruct.books[i].chapterCount;
				}

				nTestament = 1;
				nTestamentStartChapter = 1;
				nTestamentStartBook = 1;
				nChapterInTestament = nChapterInBible;
				for (i = 0; i < bkChpStruct.testamentCount; i++) {
					if (nChapterInTestament <= bkChpStruct.testaments[i].chapterCount) {
						break;
					}
					nTestament = nTestament + 1;
					nChapterInTestament = nChapterInTestament - bkChpStruct.testaments[i].chapterCount;
					nTestamentStartChapter = nTestamentStartChapter + bkChpStruct.testaments[i].chapterCount;
					nTestamentStartBook = nTestamentStartBook + bkChpStruct.testaments[i].bookCount;
				}

				$("#testamentName").html(bkChpStruct.testaments[nTestament-1].name);

				var chapterSelect = document.getElementById("chapterSelect");
				chapterSelect.options.length = 0;
				for (i = 0; i < bkChpStruct.books[nBook-1].chapterCount; i++) {
					chapterSelect.options[chapterSelect.options.length] = new Option(i+1, nBookStartChapter+i);
				}

				var tstBookSelect = document.getElementById("tstBookSelect");
				var tstChapterSelect = document.getElementById("tstChapterSelect");
				tstBookSelect.options.length = 0;
				tstChapterSelect.options.length = 0;
				var nChapter = nTestamentStartChapter;
				for (i = 0; i < bkChpStruct.testaments[nTestament-1].bookCount; i++) {
					tstBookSelect.options[tstBookSelect.options.length] = new Option(i+1, nChapter);
					nChapter = nChapter + bkChpStruct.books[nTestamentStartBook-1 + i].chapterCount;
				}
				for (i = 0; i < bkChpStruct.testaments[nTestament-1].chapterCount; i++) {
					tstChapterSelect.options[tstChapterSelect.options.length] = new Option(i+1, nTestamentStartChapter+i);
				}

				bDoingLocateUpdate = true;
				$("#bookSelect").val(nBookStartChapter);
				$("#chapterSelect").val(nChapterInBible);

				$("#tstBookSelect").val(nBookStartChapter);
				$("#tstChapterSelect").val(nChapterInBible);

				$("#bblBookSelect").val(nBookStartChapter);
				$("#bblChapterSelect").val(nChapterInBible);
				bDoingLocateUpdate = false;
			}

		</script>
		<style type="text/css">
			html {
				height: 100%;
				width: 100%;
			}
			#mainbody {
				opacity: 0;
				-webkit-transition: all 0.3s ease-in-out;
				-moz-transition: all 0.3s ease-in-out;
				-o-transition: all 0.3s ease-in-out;
				transition: all 0.3s ease-in-out;
			}

			#splash {
				position: fixed;
				text-align: center;
				vertical-align: center;
				width: 100%;
				height: 100%;
				top: 0px;
				left: 0px;
				bottom: 0px;
				right: 0px;
				background: rgba(0,0,0,0.7);
				z-index: 65535;
				margin: auto;
				border-spacing: 0;
				overflow: auto;
			}

			#splashImage {
				position: fixed;
				text-align: center;
				vertical-align: center;
				width: 100%;
				height: auto;
				top: 0px;
				left: 0px;
				bottom: 0px;
				right: 0px;
				background: rgba(0,0,0,0.7);
				z-index: 65535;
				margin: auto;
				border-spacing: 0;
				overflow: auto;
			}

			table.searchPhraseOpts {
				white-space: nowrap;
				width: 100%;
				text-align: left;
			}

			table.searchPhraseTable {
				margin-left: auto;
				margin-right: auto;
				border-collapse: collapse;
				border-spacing: 0;
			}

			table.searchSpec {
				margin-left: auto;
				margin-right: auto;
				border-collapse: collapse;
				border-spacing: 0;
			}

			td.searchPhraseTable {
				text-align: left;
				vertical-align: center;
				padding:0; margin:0;
			}

			td.shrink {
				width: 1%;
				white-space: nowrap;
			}

			td.expand {
				width: 99%;
			}

			td.expand2 {
				width: 49%;
			}

			td.centered {
				text-align: center;
			}

			img {
				max-width: 100%;
			}

			input, textarea {
				max-width: 100%;
			}

			.ui-tabs .ui-tabs-panel {
				padding: 0;
			}

			.ui-accordion .ui-accordion-content {
				padding: 0;
			}

			.ui-dialog {
				overflow: visible;
			}
			div.ui-selectmenu-open {
				position: absolute;
				z-index: 49152;
			}

			#detailsDialog {
				max-width: 100%;
			}
			pre {
				white-space: pre-wrap;       /* CSS 3 */
				white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
				white-space: -pre-wrap;      /* Opera 4-6 */
				white-space: -o-pre-wrap;    /* Opera 7 */
				word-wrap: break-word;       /* Internet Explorer 5.5+ */
			}

			span.fancytree-title {
				white-space: normal;
				max-width: 100%;
				padding: 0;
			}

			.book { font-size:xx-large; font-weight:bold; }
			.chapter { font-size:x-large; font-weight:bold; }
			.verse { display: inline-block; }
			.verselemma { display: flex; flex-wrap: wrap; }
			.word { display: inline-block; padding: 0em 0.5em 0em 0em; }
			.ref:dir(ltr) { float: left; padding: 0em 0.5em 0em 0em; }
			.ref:dir(rtl) { float: right; padding: 0em 0em 0em 0.5em; }
			.stack { display: block; }
			.main { font-size:large; }
			.interlinear { font-size:large; }
			.strongs { font-size:medium; }
			.morph { font-size:medium; }
			.subtitle { font-size:medium; font-weight:normal; font-style:italic; }
			.category { font-size:medium; font-weight:normal; }
			.superscription { font-size:medium; font-weight:normal; font-style:italic; }
			.colophon { font-size:medium; font-weight:normal; font-style:italic; }

			.selected { background:LightGoldenRodYellow; }

			.searchPhrase {
				max-width: 100%;
			}

			.searchPhraseOccurrences {
				white-space: nowrap;
				display:inline
			}

			.searchPhraseAC {
				margin: 0 5px 0 0;
				width: 100%;
				max-width: 100%;
			}
			.searchPhraseText {
				margin: 0 5px 5px 0;
				width: 100%;
				max-width: 100%;
			}
			.searchPhraseBesome {
				width: 32px;
				height: 32px;
				margin: 0 auto;
				background: none;
				border: 0;
				box-shadow: none;
				border-radius: 0px;
			}
			.searchPhraseClose {
				width: 32px;
				height: 32px;
				margin: 0 auto;
				background: none;
				border: 0;
				box-shadow: none;
				border-radius: 0px;
			}
			.searchPhraseBreak {
				max-width: 100%;
				margin: 0px;
			}

			#addSearchPhraseButton {
				margin:0px;
			}

			#moreSearchResults {
				text-align:center;
			}
			#getMoreSearchResultsButton {
				margin:0px;
			}

			#output {
				width: 500px;
				height: 75px;
			}
			#searchSpec {
				width: 100%;
				margin: 0 auto;
			}
			#searchScope {
				width: 100%;
				max-width: 100%;
				padding: 0;
				margin: 0 auto;
			}
			#checkboxitem {
				width: 100%;
				max-width: 100%;
				padding: 0;
				margin: 0 auto;
			}
			#constrainTo {
				padding: 0;
				margin: 0 auto;
			}
			#searchResultsSummary {
				text-align: center;
				width: 100%;
				margin: 0 auto;
			}
			#searchResults {
				list-style-type: none;
				width: 100%;
				min-height: 300px;
				max-height: auto;
				margin-left: auto;
				margin-right: auto;
			}
			.kjpbs_link {
				text-align: center;
			}
			.scriptureText {
				width: 100%;
				min-height: 300px;
				max-height: auto;
				margin: 0 auto;
				margin-bottom: 45px;
			}

			#scriptureNav_buttonset {
				text-align: center;
			}

			#scriptureNav .scriptureNav_box {
				position: fixed;
				text-align: center;
				overflow: hidden;
				z-index: -1;
				opacity: 0;
				width: 100%;
				height: auto;
				left: 0px;
				bottom: 0px;
				background: rgba(0,0,0,0.4);
				-webkit-transition: all 0.3s ease-in-out;
				-moz-transition: all 0.3s ease-in-out;
				-o-transition: all 0.3s ease-in-out;
				transition: all 0.3s ease-in-out;
			}
			#toggle-nav { display: none; }

			#toggle-nav:checked ~ .scriptureNav_box {
				opacity: 1;
				z-index: 400;
			}
			#toggle-nav:checked ~ .scriptureNav_box div {
				-webkit-transform: scale(1);
				-moz-transform: scale(1);
				-ms-transform: scale(1);
				transform: scale(1);
			}

			@font-face {
				font-family: "loading-demo";
				src: url('jquery/jquery-ui/jquery-loading-overlay/demo/fonts/icons.woff') format("woff"), url('jquery/jquery-ui/jquery-loading-overlay/demo/fonts/icons.ttf') format("truetype");
			}
			@-moz-keyframes loadingStart {
				0% {
					opacity: 0;
				}
				100% {
					opacity: 1;
				}
			}
			@-webkit-keyframes loadingStart {
				0% {
					opacity: 0;
				}
				100% {
					opacity: 1;
				}
			}
			@-o-keyframes loadingStart {
				0% {
					opacity: 0;
				}
				100% {
					opacity: 1;
				}
			}
			@keyframes loadingStart {
				0% {
					opacity: 0;
				}
				100% {
					opacity: 1;
				}
			}
			@-moz-keyframes loading {
				0% {
					-moz-transform: rotate(0deg);
					transform: rotate(0deg);
				}
				50% {
					-moz-transform: rotate(180deg);
					transform: rotate(180deg);
				}
				100% {
					-moz-transform: rotate(360deg);
					transform: rotate(360deg);
				}
			}
			@-webkit-keyframes loading {
				0% {
					-webkit-transform: rotate(0deg);
					transform: rotate(0deg);
				}
				50% {
					-webkit-transform: rotate(180deg);
					transform: rotate(180deg);
				}
				100% {
					-webkit-transform: rotate(360deg);
					transform: rotate(360deg);
				}
			}
			@-o-keyframes loading {
				0% {
					-o-transform: rotate(0deg);
					transform: rotate(0deg);
				}
				50% {
					-o-transform: rotate(180deg);
					transform: rotate(180deg);
				}
				100% {
					-o-transform: rotate(360deg);
					transform: rotate(360deg);
				}
			}
			@keyframes loading {
				0% {
					transform: rotate(0deg);
				}
				50% {
					transform: rotate(180deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}

			.loading {
				position: relative;
				pointer-events: none;
			}

			.loading-background {
				width:100%;
				height:100%;
				top:0;
				margin: 0;
				background: rgba(0, 0, 0, 0);
				display:none;
				position: fixed;
				z-index:1000;
			}

			.loading .loading-overlay {
				z-index: 65535;
				position: fixed;
				top: 0;
				bottom: 0;
				left: 0;
				right: 0;
				-webkit-animation: loadingStart 2s 300ms linear 1 both;
				-moz-animation: loadingStart 2s 300ms linear 1 both;
				-o-animation: loadingStart 2s 300ms linear 1 both;
				animation: loadingStart 2s 300ms linear 1 both;
				background: rgba(255, 255, 255, 0.5);
				text-align: center;
			}
			.loading .loading-text {
				font-size: 0.875rem;
				line-height: 1.3125rem;
				text-shadow: white 0 0 1em, white 0 0 0.5em, white 0 0 0.25em;
				position: relative;
				display: block;
				text-transform: uppercase;
				font-weight: bold;
			}
			.loading .loading-text:after {
				content: "...";
			}
			.loading .loading-spinner {
				position: absolute;
				top: 50%;
				bottom: 0;
				left: 0;
				right: 0;
				margin: -3.9375rem auto 0;
				color: #1a1d1d;
				text-align: center;
			}
			.loading .loading-icon {
				font-size: 4.8125rem;
				line-height: 5.25rem;
				text-shadow: rgba(255, 255, 255, 0.75) 0 0 0.5em;
				-webkit-animation: loading 1s steps(4) infinite;
				-moz-animation: loading 1s steps(4) infinite;
				-o-animation: loading 1s steps(4) infinite;
				animation: loading 1s steps(4) infinite;
				display: block;
				vertical-align: middle;
			}
			.loading .loading-icon:before {
				vertical-align: middle;
				content: "\e000";
				font-family: "loading-demo";
			}

		</style>
	</head>
	<body>
		<div id="splash">
			<img id="splashImage" src="KJPBS_Splash_20130405_194312.jpeg" alt="KJPBS Splash Screen">
		</div>
		<div id="loading-background" class="loading-background"></div>
		<div id="loading-target" class="loading">
			<div class="loading-overlay" id="loading-overlay">
				<p class="loading-spinner">
					<span class="loading-icon"></span>
					<span class="loading-text">loading</span>;
				</p>
			</div>
		</div>
		<div id="status" style="display:none;">
			<h1>King James Pure Bible Search</h1>
			<h2>WebChannel Server</h2>
			<textarea id="output"></textarea><br /><br />
			<button type="button" id="reconnectButton" onclick="javascript:reconnect();">Reconnect to Server</button><br /><br />
		</div>
		<div id="mainbody">
			<div id="tabs">
				<ul>
					<li><a href="#search"><span>Search</span></a></li>
					<li><a href="#browser"><span>Scripture Browser</span></a></li>
				</ul>

				<div id="search">
					<div id="detailsDialog" title="Details">
					</div>
					<table class="searchSpec" id="searchSpec">
						<tr>
							<td class="expand">
								<div id="searchCriteria">
									<div id="searchWithin">
										<h3>Search Within</h3>
										<div id="searchWithinTree"></div>
									</div>
									<label style="display: block;" for="searchScope">Search Scope:</label>
									<select class="searchScope" name="searchScope" id="searchScope" title="Select Search Scope">
										<option value="-1">Anywhere in Selected Text</option>
										<option value="0">Together in Selected Text</option>
										<option value="1">Same Testament</option>
										<option value="2">Same Book</option>
										<option value="3">Same Chapter</option>
										<option value="4">Same Verse</option>
									</select>
								</div>
							</td>
						</tr>
						<tr>
							<td>
								<hr />
							</td>
						</tr>
						<tr>
							<td class="expand">
								<div id="phrases"></div>
							</td>
						</tr>
						<tr>
							<td class="expand" style="text-align:center">
								<div id="searchControls">
									<button type="button" id="addSearchPhraseButton" onclick="javascript:addSearchPhrase();">Add Search Phrase</button>
								</div>
							</td>
						</tr>
						<tr>
							<td class="expand">
								<div id="searchResultsSummary"></div>
							</td>
						</tr>
						<tr>
							<td>
								<hr />
								<div class="kjpbs_link"><a href="//www.purebiblesearch.com/" target="_blank">Visit PureBibleSearch.com</a></div>
								<hr />
							</td>
						</tr>
						<tr>
							<td class="expand">
								<div id="searchResults"></div>
								<div id="moreSearchResults">
									<button type="button" id="getMoreSearchResultsButton" onclick="javascript:getMoreSearchResults();">Get More Search Results</button>
								</div>
							</td>
						</tr>
					</table>
				</div>

				<div id="browser">
					<div id="locateDialog" title="Locate">
						<table class="locateControlsTable" id="locateControlsTable">
						</table>
					</div>
					<div id="scriptureBook">
						<select class="selectBibleList" name="selectBibleList" id="selectBibleList">
						</select>
						<div id="bibleAudioControls" class="bibleAudio" style="display:none;">
							<h3>Bible Audio</h3>
							<div id="bibleAudioContent" class="bibleAudio">
								<table id="bibleAudioContentTable" style="width:100%;">
								</table>
							</div>
						</div>
						<div id="scriptureText" class="scriptureText"></div>
					</div>
				</div>
			</div>
			<nav id="scriptureNav">
				<input type="checkbox" id="toggle-nav" />
				<div class="scriptureNav_box">
					<div id="scriptureNav_buttonset">
						<button type="button" id="prevChpButton" onclick="javascript:navPrevChapter();">Prev</button>
						<button type="button" id="locateButton" onclick="javascript:navLocate();">Locate</button>
						<button type="button" id="nextChpButton" onclick="javascript:navNextChapter();">Next</button>
					</div>
				</div>
			</nav>
		</div>

		<script>
			var initJsonSearchWithinTree = [ ];

			$( "#reconnectButton" ).button();

			$(document).tooltip();
			$( "#tabs" ).tabs({
				activate: function( event, ui ) {
					if ($(this).tabs("option", "active") == 1) {
						document.getElementById("toggle-nav").checked = true;
					} else {
						document.getElementById("toggle-nav").checked = false;
					}
				}
			});
			$( "#addSearchPhraseButton" ).button();
			$( "#searchWithin" ).accordion({
				collapsible: true,
				animate: 200,
				active: false,
				heightStyle: "content"
			});
			$( "#searchScope" ).selectmenu({
				width : '100%',
				style: 'dropdown',
				select: function(event, ui) { searchPhraseChanged(); }
			}).selectmenu("menuWidget").addClass("overflow");
			$( "#searchScope" ).selectmenu().data("ui-selectmenu")._renderItem =
			function( ul, item ) {
				var li = $( "<li>" )
						.css( "background-color", item.value );

				if ( item.disabled ) {
					li.addClass( "ui-state-disabled" );
				}

				this._setText( li, item.label );

				if (item.value == -1)
					li.attr("title", "Anywhere is an Unscoped Search finding the search phrases indepdendent of one another within the selected text");
				if (item.value == 0)
					li.attr("title", "Together is a Scoped Search requiring that all search phrases be found within the selected text");
				if (item.value == 1)
					li.attr("title", "Same Testament is a Scoped Search requiring that all search phrases be found together in the same Testament within the selected text");
				if (item.value == 2)
					li.attr("title", "Same Book is a Scoped Search requiring that all search phrases be found together in the same Book within the selected text");
				if (item.value == 3)
					li.attr("title", "Same Chapter is a Scoped Search requiring that all search phrases be found together in the same Chapter within the selected text");
				if (item.value == 4)
					li.attr("title", "Same Verse is a Scoped Search requiring that all search phrases be found together in the same Verse within the selected text");

				return li.appendTo( ul );
			}

			$( "#searchWithinTree" ).fancytree({
				extensions: ["themeroller"],
				checkbox: true,
				selectMode: 3,
				icons: false,
				tabbable: true,
				titlesTabbable: true,
				autoScroll: true,
				activeVisible: true,
				minExpandLevel: 2,
				source: initJsonSearchWithinTree,
//				source: { url: "testit.json", cache: false },
//				loadChildren: function(event, ctx) {
//					ctx.node.fixSelection3AfterClick();
//					ctx.node.fixSelection3FromEndNodes();
//				},
				select: function(event, data) {
					searchPhraseChanged();
				},
				dblclick: function(event, data) {
					data.node.toggleSelected();
				},
				keydown: function(event, data) {
					if( event.which === 32 ) {
						data.node.toggleSelected();
						return false;
					}
				},
				// The following options are only required, if we have more than one tree on one page:
				//        initId: "treeData",
				cookieId: "fancytree-searchWithinTree",
				idPrefix: "fancytree-searchWithinTree-"
			});

			$( "#scriptureNav_buttonset" ).buttonset();

			// Generate locateDialog:
			var locateControlsTable = $("#locateControlsTable");
			if (($(window).width() < 512) || ($(window).height() < 512)) {
				locateControlsTable.append('<tr><td class="centered">Book/Chapter:</td></tr>');
				locateControlsTable.append('<tr><td class="centered"><select class="bookSelect" name="bookSelect" id="bookSelect"></select>' +
											'<select class="chapterSelect" name="chapterSelect" id="chapterSelect"></select></td></tr>');
				locateControlsTable.append('<tr><td class="centered"><hr /></td></tr>');
				locateControlsTable.append('<tr><td class="centered"><div class="testamentName" name="testamentName" id="testamentName">&nbsp;</div></td></tr>');
				locateControlsTable.append('<tr><td class="centered"><label style="display: inline;" for="tstBookSelect">Book:</label><select class="tstBookSelect" name="tstBookSelect" id="tstBookSelect"></select></td></tr>');
				locateControlsTable.append('<tr><td class="centered"><label style="display: inline;" for="tstChapterSelect">Chapter:</label><select class="tstChapterSelect" name="tstChapterSelect" id="tstChapterSelect"></select></td></tr>');
				locateControlsTable.append('<tr><td class="centered"><hr /></td></tr>');
				locateControlsTable.append('<tr><td class="centered">Entire Bible:</td></tr>');
				locateControlsTable.append('<tr><td class="centered"><label style="display: inline;" for="bblBookSelect">Book:</label><select class="bblBookSelect" name="bblBookSelect" id="bblBookSelect"></select></td></tr>');
				locateControlsTable.append('<tr><td class="centered"><label style="display: inline;" for="bblChapterSelect">Chapter:</label><select class="bblChapterSelect" name="bblChapterSelect" id="bblChapterSelect"></select></td></tr>');
				locateControlsTable.append('<tr><td class="centered"><hr /></td></tr>');
				locateControlsTable.append('<tr><td class="centered"><label style="display: block;" id="passageReferenceLabel" for="passageReference">Enter Passage Reference:</label><input class="passageReference" name="passageReference" id="passageReference"  autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></input></td></tr>');
				locateControlsTable.append('<tr><td class="centered"><hr /></td></tr>');
				locateControlsTable.append('<tr><td class="centered"><button type="button" id="gotoPassageButton">Go to Passage</button></td></tr>');
			} else {
				locateControlsTable.append('<tr><td class="shrink">Book/Chapter:</td>' +
											'<td class="expand2" style="border-left:1px solid black;">&nbsp;</td>' +
											'<td class="shrink" colspan="2"><div class="testamentName" name="testamentName" id="testamentName">&nbsp;</div></td>' +
											'<td class="expand2" style="border-right:1px solid black;">&nbsp;</td>' +
											'<td class="shrink" colspan="2">Entire Bible:</td></tr>');
				locateControlsTable.append('<tr><td class="shrink"><select class="bookSelect" name="bookSelect" id="bookSelect"></optgroup></select></td>' +
											'<td class="expand2" style="border-left:1px solid black;">&nbsp;</td>' +
											'<td class="shrink"><label style="display: inline;" for="tstBookSelect">Book:</label></td><td><select class="tstBookSelect" name="tstBookSelect" id="tstBookSelect"></select></td>' +
											'<td class="expand2" style="border-right:1px solid black;">&nbsp;</td>' +
											'<td class="shrink"><label style="display: inline;" for="bblBookSelect">Book:</label></td><td><select class="bblBookSelect" name="bblBookSelect" id="bblBookSelect"></select></td></tr>');
				locateControlsTable.append('<tr><td class="shrink"><select class="chapterSelect" name="chapterSelect" id="chapterSelect"></select></td>' +
											'<td class="expand2" style="border-left:1px solid black;">&nbsp;</td>' +
											'<td class="shrink"><label style="display: inline;" for="tstChapterSelect">Chapter:</label></td><td><select class="tstChapterSelect" name="tstChapterSelect" id="tstChapterSelect"></select></td>' +
											'<td class="expand2" style="border-right:1px solid black;">&nbsp;</td>' +
											'<td class="shrink"><label style="display: inline;" for="bblChapterSelect">Chapter:</label></td><td><select class="bblChapterSelect" name="bblChapterSelect" id="bblChapterSelect"></select></td></tr>');
				locateControlsTable.append('<tr><td class="centered" colspan="7"><hr /></td></tr>');
				locateControlsTable.append('<tr><td class="centered" colspan="7"><label style="display: inline;" id="passageReferenceLabel" for="passageReference">Enter Passage Reference:</label><input class="passageReference" name="passageReference" id="passageReference"  autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></input></td></tr>');
				locateControlsTable.append('<tr><td class="centered" colspan="7"><hr /></td></tr>');
				locateControlsTable.append('<tr><td class="centered" colspan="7"><button type="button" id="gotoPassageButton">Go to Passage</button></td></tr>');
			}

			$("#bookSelect").on("change", function() {
				if (!bDoingLocateUpdate) {
					setLocateDialogToChapter($("#bookSelect").val());
				}
			});
			$("#chapterSelect").on("change", function() {
				if (!bDoingLocateUpdate) {
					setLocateDialogToChapter($("#chapterSelect").val());
				}
			});
			$("#tstBookSelect").on("change", function() {
				if (!bDoingLocateUpdate) {
					setLocateDialogToChapter($("#tstBookSelect").val());
				}
			});
			$("#tstChapterSelect").on("change", function() {
				if (!bDoingLocateUpdate) {
					setLocateDialogToChapter($("#tstChapterSelect").val());
				}
			});
			$("#bblBookSelect").on("change", function() {
				if (!bDoingLocateUpdate) {
					setLocateDialogToChapter($("#bblBookSelect").val());
				}
			});
			$("#bblChapterSelect").on("change", function() {
				if (!bDoingLocateUpdate) {
					setLocateDialogToChapter($("#bblChapterSelect").val());
				}
			});
			$("#passageReference").on('change keyup paste input', function() {
				// Can't clear ndxPassageReference here or we'll get into an
				//		event race condition with the server validating and
				//		our navigating to the target.  So we'll just have
				//		to use stale data.  At least color should tell user
				//		that it won't be right:
				var strPassRef = $(this).val().trim();
				if (strPassRef.length) {
					document.getElementById("passageReference").style.color = "#FF0000";
					document.getElementById("passageReferenceLabel").style.color = "#FF0000";
					resolvePassageReference(strPassRef);
				} else {
					document.getElementById("passageReference").style.color = "#000000";
					document.getElementById("passageReferenceLabel").style.color = "#000000";
				}
			});

			$("#gotoPassageButton").on("click", function () {
				document.getElementById("gotoPassageButton").blur();	// Workaround jqueryui bug
				$("#gotoPassageButton").removeClass('ui-state-focus ui-state-hover ui-state-active');

				if (ndxPassageReference != 0) {
					gotoIndex(ndxPassageReference, 0, ((relIndexVerse(ndxPassageReference) == 1) ? "scrollTabTop" : "scrollToAnchor"));
				} else {
					if ($("#passageReference").val().trim().length) {
						alert("That passage reference isn't valid!");
						$("#passageReference").focus();
						return;
					} else {
						gotoChapter($("#bblChapterSelect").val(), "scrollTabTop");
					}
				}
				$("#locateDialog").dialog("close");
			});

			$( "#gotoPassageButton" ).button();

			$( "#detailsDialog" ).dialog({
				autoOpen: false,
				width: "auto",
				open: function( event, ui ) {
					// Blur the close button to get rid of annoying tooltip with it
					//		from popping up automatically:
					$(".ui-dialog-titlebar-close").blur();
				}
			});

			$( "#locateDialog" ).dialog({
				autoOpen: false,
				modal: true,
				width: "auto",
				open: function( event, ui ) {
					document.getElementById("toggle-nav").checked = false;
					// Only focus passageReference if on a large screen device, otherwise
					//		it's very annoying:
					if (!isTouchDevice()) {
						document.getElementById("passageReference").focus();
					}
				},
				close: function( event, ui ) {
					document.getElementById("toggle-nav").checked = ($("#tabs").tabs("option", "active") == 1);
					$("#passageReference").val("");
					document.getElementById("passageReference").style.color = "#000000";
					document.getElementById("passageReferenceLabel").style.color = "#000000";
				}
			});

			$( "#selectBibleList" ).selectmenu({
				width : '100%',
				style: 'dropdown',
				select: function(event, ui) { selectBible(); }
			}).selectmenu("menuWidget").addClass("overflow");
			$( "#selectBibleList" ).selectmenu().data("ui-selectmenu")._renderItem =
			function( ul, item ) {
				var li = $( "<li>" )
						.css( "background-color", item.value );

				if ( item.disabled ) {
					li.addClass( "ui-state-disabled" );
				}

				this._setText( li, item.label );

				return li.appendTo( ul );
			}

			$( "#bibleAudioControls" ).accordion({
				width: "100%",
				collapsible: true,
				animate: 200,
				active: false,
				heightStyle: "content"
			});
			var bibleAudioControlsTable = $("#bibleAudioContentTable");
			if (($(window).width() < 512) || ($(window).height() < 512)) {
				bibleAudioControlsTable.append('<tr><td style="white-space: nowrap;">Select Bible Audio:</td></tr>');
				bibleAudioControlsTable.append('<tr><td><select class="selectBibleAudio" name="selectBibleAudio" id="selectBibleAudio"></select></td></tr>');
				bibleAudioControlsTable.append('<tr><td><input type="checkbox" id="bibleAudioPlayNext" /><label for="bibleAudioPlayNext">Auto Play Next Chapter</label></td></tr>');
				bibleAudioControlsTable.append('<tr><td><label for="bibleAudioSpeed" style="display:inline">Playback Speed:&nbsp;</label><select class="bibleAudioSpeed" name="bibleAudioSpeed" id="bibleAudioSpeed" onchange="javascript:changedBibleAudioSpeed();"></select></td></tr>');
				bibleAudioControlsTable.append('<tr><td class="expand"><div id="bibleAudio" class="bibleAudio" style="display:none;"></div></td></tr>');
			} else {
				bibleAudioControlsTable.append('<tr>' +
						'<td class="shrink" style="white-space: nowrap;">Select Bible Audio:</td>' +
						'<td class="expand" style="border-left: 2px solid;"><label for="bibleAudioSpeed" style="display:inline">Playback Speed:&nbsp;</label><select class="bibleAudioSpeed" name="bibleAudioSpeed" id="bibleAudioSpeed" onchange="javascript:changedBibleAudioSpeed();"></select></td>' +
						'</tr>');
				bibleAudioControlsTable.append('<tr>' +
						'<td class="shrink"><select class="selectBibleAudio" name="selectBibleAudio" id="selectBibleAudio"></select></td>' +
						'<td class="expand" style="border-left: 2px solid;"><input type="checkbox" id="bibleAudioPlayNext" /><label for="bibleAudioPlayNext">Auto Play Next Chapter</label></td>' +
						'</tr>');
				bibleAudioControlsTable.append('<tr>' +
						'<td colspan="2" class="expand"><div id="bibleAudio" class="bibleAudio" style="display:none;"></div></td>' +
						'</tr>');
			}
			$("#selectBibleAudio").on("change", function() {
				setBibleAudio();
			});
			$("<option value='0.5'>x0.5</option>").appendTo("#bibleAudioSpeed");
			$("<option value='0.6'>x0.6</option>").appendTo("#bibleAudioSpeed");
			$("<option value='0.7'>x0.7</option>").appendTo("#bibleAudioSpeed");
			$("<option value='0.8'>x0.8</option>").appendTo("#bibleAudioSpeed");
			$("<option value='0.9'>x0.9</option>").appendTo("#bibleAudioSpeed");
			$("<option value='1.0'>x1.0</option>").appendTo("#bibleAudioSpeed");
			$("<option value='1.1'>x1.1</option>").appendTo("#bibleAudioSpeed");
			$("<option value='1.2'>x1.2</option>").appendTo("#bibleAudioSpeed");
			$("<option value='1.3'>x1.3</option>").appendTo("#bibleAudioSpeed");
			$("<option value='1.4'>x1.4</option>").appendTo("#bibleAudioSpeed");
			$("<option value='1.5'>x1.5</option>").appendTo("#bibleAudioSpeed");
			$("<option value='1.6'>x1.6</option>").appendTo("#bibleAudioSpeed");
			$("<option value='1.7'>x1.7</option>").appendTo("#bibleAudioSpeed");
			$("<option value='1.8'>x1.8</option>").appendTo("#bibleAudioSpeed");
			$("<option value='1.9'>x1.9</option>").appendTo("#bibleAudioSpeed");
			$("<option value='2.0'>x2.0</option>").appendTo("#bibleAudioSpeed");
			$("#bibleAudioSpeed").val('1.0');

			$( "#getMoreSearchResultsButton" ).button();
			document.getElementById("moreSearchResults").style.display = 'none';

			$("#loading-target").loadingOverlay();
			$("#loading-target").loadingOverlay("remove");

//			var markup = document.getElementsByTagName('body')[0].innerHTML;
//			alert(markup);

			hideKeyboard();		// Hurry up and get it out of the way of the splash screen
			$("#splash").delay(2000).fadeOut(2000);
			$("#mainbody").delay(2000).fadeIn(2000, function() {
				$("#mainbody").css("opacity", "1");
			});

			addSearchPhrase();			// Add initial search phrase
		</script>


	</body>
</html>
